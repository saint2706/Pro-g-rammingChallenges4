var X=Object.defineProperty;var Y=(s,e,t)=>e in s?X(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var c=(s,e,t)=>Y(s,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}})();const j={up:{row:-1,col:0},right:{row:0,col:1},down:{row:1,col:0},left:{row:0,col:-1}},A={empty:[],source:["right"],sink:["left"],straight:["up","down"],corner:["up","right"],tee:["up","left","right"],cross:["up","right","down","left"]};let x=0;function M(){return x+=1,x}function k(s){return{...s,id:M()}}function B(){return{id:M(),type:"empty",rotation:0}}function H(s,e){const t=["up","right","down","left"],n=t.indexOf(s),r=(e/90%4+4)%4;return t[(n+r)%4]}function I(s,e){return s.map(t=>H(t,e))}function z(s){const e=A[s.type];return!e||e.length===0?[]:I(e,s.rotation)}function K(s){return{up:"down",right:"left",down:"up",left:"right"}[s]}function y(s){return`${s.row},${s.col}`}function S(s){return Math.floor(Math.random()*s)}function F(s){const e=[...s];for(let t=e.length-1;t>0;t-=1){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}function R(s,e,t){return s.row>=0&&s.row<e&&s.col>=0&&s.col<t}function V(s){const e=Math.min(6+Math.floor(s/2),10),t=Math.min(6+Math.ceil(s/2),12),n=Math.max(60,150-s*12),r=Math.min(e*t,Math.floor(e*t*.45)+s+4);return{rows:e,cols:t,timeLimit:n,paletteSize:r}}function _(s,e,t,n){const r=[],o=new Set,a=i=>{if(r.push(i),i.row===n.row&&i.col===n.col)return!0;o.add(y(i));const u=F([{row:i.row-1,col:i.col},{row:i.row+1,col:i.col},{row:i.row,col:i.col-1},{row:i.row,col:i.col+1}]).filter(l=>R(l,s,e)&&!o.has(y(l)));u.sort((l,d)=>{const p=Math.abs(l.row-n.row)+Math.abs(l.col-n.col),f=Math.abs(d.row-n.row)+Math.abs(d.col-n.col);return p-f+(Math.random()-.5)});for(const l of u)if(a(l))return!0;return r.pop(),o.delete(y(i)),!1};return a(t),r}function Z(s){switch([...s].sort().join(",")){case"down,up":case"left,right":return"straight";case"down,right":case"down,left":case"left,up":case"right,up":return"corner";case"down,left,right":case"left,right,up":case"down,left,up":case"down,right,up":return"tee";case"down,left,right,up":return"cross";default:return"empty"}}function D(s,e){const t=A[s];if(!t||t.length===0)return 0;for(const n of[0,90,180,270]){const r=I(t,n);if(r.length===e.length&&r.every(a=>e.includes(a)))return n}return 0}function L(s,e,t=!1){return{id:M(),type:s,rotation:e,locked:t}}function J(s){const e=V(s),{rows:t,cols:n}=e,r=Array.from({length:t},()=>Array.from({length:n},()=>B())),o={row:S(t),col:0},a={row:S(t),col:n-1},i=_(t,n,o,a),u=new Map,l=[];i.forEach((h,m)=>{const w=y(h);if(m===0){const b=i[m+1],T=b?E(h,b):"right",C=D("source",[T]),v=L("source",C,!0);r[h.row][h.col]=v,u.set(w,k(v))}else if(m===i.length-1){const b=i[m-1],T=b?E(h,b):"left",C=D("sink",[T]),v=L("sink",C,!0);r[h.row][h.col]=v,u.set(w,k(v))}else{const b=i[m-1],T=i[m+1],C=[E(h,b),E(h,T)],v=Z(C),G=D(v,C),q=L(v,G,!1);u.set(w,k(q)),l.push(k(q))}});const d=Math.max(2,Math.min(e.paletteSize-l.length,s+4)),p=["straight","corner","tee"];for(let h=0;h<d;h+=1){const m=p[S(p.length)],w=[0,90,180,270][S(4)];l.push(L(m,w))}const f=F(l).map(h=>({...h,id:M()}));return{board:r,palette:f,source:o,sink:a,solution:u,levelConfig:e}}function E(s,e){return e.row===s.row?e.col>s.col?"right":"left":e.row>s.row?"down":"up"}function Q(s,e){const t=new Set,n=[],r=[e],o=new Set([y(e)]);for(;r.length>0;){const i=r.shift(),u=s[i.row][i.col],l=z(u);t.add(y(i)),l.forEach(d=>{const p=j[d],f={row:i.row+p.row,col:i.col+p.col};if(!R(f,s.length,s[0].length)){n.push(i);return}const h=s[f.row][f.col];if(h.type==="empty"){n.push(f);return}if(!z(h).includes(K(d))){n.push(f);return}const w=y(f);o.has(w)||(o.add(w),r.push(f))})}return{reachedSink:Array.from(t).some(i=>{const[u,l]=i.split(",").map(Number);return s[u][l].type==="sink"})&&n.length===0,leaking:n,visited:t}}function ee(s,e,t){return!t||s[e.row][e.col].locked?!1:(s[e.row][e.col]={...t.tile,id:M(),locked:!1},!0)}function te(s,e){const t=s[e.row][e.col];return t.locked?null:(s[e.row][e.col]=B(),t)}function se(s,e){for(let t=0;t<s.length;t+=1)for(let n=0;n<s[t].length;n+=1){const r=y({row:t,col:n}),o=e.solution.get(r);o&&o.locked?s[t][n]=k(o):s[t][n]=B()}}function ne(s,e){for(let t=0;t<s.length;t+=1)for(let n=0;n<s[t].length;n+=1)s[t][n].highlighted=!1;e.forEach(t=>{R(t,s.length,s[0].length)&&(s[t.row][t.col].highlighted=!0)})}const g=72,P=24;class re{constructor(e){c(this,"canvas");c(this,"ctx");c(this,"paletteContainer");c(this,"messageElement");c(this,"stats");c(this,"advanceButton");c(this,"resetButton");c(this,"level",1);c(this,"score",0);c(this,"timeRemaining",0);c(this,"board",[]);c(this,"palette",[]);c(this,"puzzle",null);c(this,"dragPayload",null);c(this,"dragPosition",{x:0,y:0});c(this,"lastTick",performance.now());c(this,"levelComplete",!1);c(this,"leakCount",0);c(this,"statusTone","info");this.canvas=e.canvas;const t=this.canvas.getContext("2d");if(!t)throw new Error("Canvas context unavailable");this.ctx=t,this.paletteContainer=e.paletteContainer,this.messageElement=e.messageElement,this.stats=e.stats,this.advanceButton=e.advanceButton,this.resetButton=e.resetButton,this.canvas.addEventListener("pointerdown",n=>this.onCanvasPointerDown(n)),window.addEventListener("pointermove",n=>this.onPointerMove(n)),window.addEventListener("pointerup",n=>this.onPointerUp(n)),this.advanceButton.addEventListener("click",()=>{this.levelComplete&&(this.level+=1,this.startLevel())}),this.resetButton.addEventListener("click",()=>{this.startLevel(!0)}),this.startLevel(),requestAnimationFrame(()=>this.tick())}startLevel(e=!1){this.levelComplete&&!e||(this.levelComplete=!1,this.statusTone="info",this.setMessage("Route water from source to sink. Use all the time you can to earn more points.","info"),this.advanceButton.disabled=!0,this.puzzle=J(this.level),this.board=this.puzzle.board.map(t=>t.map(n=>({...n}))),this.palette=this.puzzle.palette.map(t=>k(t)),this.timeRemaining=this.puzzle.levelConfig.timeLimit,this.lastTick=performance.now(),this.resizeCanvas(),this.renderPalette(),this.updateStats())}resizeCanvas(){if(!this.board.length)return;const e=this.board.length,t=this.board[0].length;this.canvas.width=t*g+P*2,this.canvas.height=e*g+P*2}renderPalette(){this.paletteContainer.innerHTML="",this.palette.forEach((e,t)=>{const n=document.createElement("div");n.className="palette-tile",n.dataset.index=t.toString();const r=document.createElement("canvas");r.width=g,r.height=g,n.appendChild(r);const o=r.getContext("2d");o&&this.drawTile(o,e,0,0,g,!0),n.addEventListener("pointerdown",a=>{a.preventDefault(),this.onPalettePointerDown(a,t)}),this.paletteContainer.appendChild(n)})}onPalettePointerDown(e,t){if(!this.palette[t])return;const[n]=this.palette.splice(t,1);this.dragPayload={tile:n,fromPalette:!0,sourceIndex:t},this.updateDragPosition(e),this.renderPalette()}onCanvasPointerDown(e){if(!this.board.length)return;const t=this.eventToCell(e);if(!t)return;const n=this.board[t.row][t.col];if(n.locked||n.type==="empty")return;const r=te(this.board,t);r&&(this.dragPayload={tile:r,fromPalette:!1,originCell:t},this.updateDragPosition(e))}onPointerMove(e){this.dragPayload&&this.updateDragPosition(e)}onPointerUp(e){if(!this.dragPayload)return;const t=this.dragPayload;this.dragPayload=null;const n=this.eventToCell(e);if(n&&this.board[n.row][n.col]&&ee(this.board,n,t)){this.updateFlowState();return}if(t.fromPalette){const r=t.sourceIndex??this.palette.length;this.palette.splice(r,0,t.tile),this.renderPalette()}else if(t.originCell){const{originCell:r}=t;this.board[r.row][r.col].type==="empty"&&(this.board[r.row][r.col]=t.tile)}}updateDragPosition(e){const t=this.canvas.getBoundingClientRect();this.dragPosition={x:e.clientX-t.left,y:e.clientY-t.top}}eventToCell(e){const t=this.canvas.getBoundingClientRect(),n=e.clientX-t.left-P,r=e.clientY-t.top-P;if(!this.board.length)return null;const o=Math.floor(r/g),a=Math.floor(n/g);return o<0||a<0||o>=this.board.length||a>=this.board[0].length?null:{row:o,col:a}}tick(){const e=performance.now(),t=(e-this.lastTick)/1e3;this.lastTick=e,this.levelComplete||(this.timeRemaining-=t,this.timeRemaining<=0&&(this.timeRemaining=0,this.onTimeExpired())),this.updateFlowState(),this.draw(),requestAnimationFrame(()=>this.tick())}draw(){const{width:e,height:t}=this.canvas;if(this.ctx.clearRect(0,0,e,t),this.ctx.save(),this.ctx.translate(P,P),this.board.length){const n=this.board.length,r=this.board[0].length;for(let o=0;o<n;o+=1)for(let a=0;a<r;a+=1){const i=this.board[o][a],u=a*g,l=o*g;this.drawTile(this.ctx,i,u,l,g,!1)}}this.dragPayload&&(this.ctx.save(),this.ctx.globalAlpha=.85,this.drawTile(this.ctx,this.dragPayload.tile,this.dragPosition.x-g/2,this.dragPosition.y-g/2,g,!1),this.ctx.restore()),this.ctx.restore()}drawTile(e,t,n,r,o,a){e.save(),e.translate(n,r);const i=o*.1;if(e.fillStyle=t.highlighted?"rgba(248,113,113,0.25)":"rgba(15,23,42,0.95)",e.strokeStyle=t.locked?"#38bdf8":"rgba(148, 163, 184, 0.35)",e.lineWidth=2,e.beginPath(),e.roundRect(1,1,o-2,o-2,12),e.fill(),e.stroke(),t.type!=="empty"){const u=z(t),l=o/2,d=o/2,p=o*.22;e.lineCap="round",e.lineWidth=p,e.strokeStyle=t.locked?"#38bdf8":"#f8fafc",u.forEach(f=>{switch(e.beginPath(),e.moveTo(l,d),f){case"up":e.lineTo(l,i);break;case"right":e.lineTo(o-i,d);break;case"down":e.lineTo(l,o-i);break;case"left":e.lineTo(i,d);break}e.stroke()}),e.beginPath(),e.lineWidth=p,e.strokeStyle=t.type==="source"?"#22d3ee":t.type==="sink"?"#f97316":"#f8fafc",e.moveTo(l,d),e.lineTo(l,d),e.stroke()}a&&(e.strokeStyle="rgba(148,163,184,0.35)",e.lineWidth=1.5,e.strokeRect(0,0,o,o)),e.restore()}updateFlowState(){if(!this.puzzle)return;const e=Q(this.board,this.puzzle.source);ne(this.board,e.leaking),this.leakCount=e.leaking.length,this.updateStats(),e.leaking.length>0&&!this.levelComplete?this.setMessage("Leaks detected! Patch the gaps to restore pressure.","warning"):this.levelComplete||this.setMessage("Build a leak-free path and reach the sink.","info"),e.reachedSink&&!this.levelComplete&&this.onLevelComplete()}onLevelComplete(){this.levelComplete=!0,this.advanceButton.disabled=!1,this.statusTone="success";const e=Math.round(this.timeRemaining*5+this.level*100);this.score+=e,this.setMessage(`Flow stabilised! Level ${this.level} cleared (+${e} pts).`,"success")}onTimeExpired(){this.puzzle&&(this.score=Math.max(0,this.score-75),this.setMessage("Time expired! Board reset and score penalised.","warning"),se(this.board,this.puzzle),this.palette=this.puzzle.palette.map(e=>k(e)),this.renderPalette(),this.timeRemaining=this.puzzle.levelConfig.timeLimit)}updateStats(){this.stats.level.textContent=this.level.toString(),this.stats.score.textContent=Math.max(0,Math.round(this.score)).toString(),this.stats.time.textContent=`${Math.ceil(this.timeRemaining)}s`,this.stats.leaks.textContent=this.leakCount.toString()}setMessage(e,t){this.statusTone===t&&this.messageElement.textContent===e||(this.statusTone=t,this.messageElement.textContent=e,this.messageElement.style.color=t==="success"?"#34d399":t==="warning"?"#f87171":"#e2e8f0")}}function oe(s){return new re(s)}document.querySelector("#app").innerHTML=`
  <div class="ui-wrapper">
    <div class="canvas-wrapper">
      <canvas id="game-canvas" width="800" height="800"></canvas>
    </div>
    <aside class="sidebar">
      <div class="badge">Challenge #108 &bull; Pipe Dreams</div>
      <div class="stats">
        <div class="stat-card"><h2>Level</h2><span id="stat-level">1</span></div>
        <div class="stat-card"><h2>Score</h2><span id="stat-score">0</span></div>
        <div class="stat-card"><h2>Time</h2><span id="stat-time">0s</span></div>
        <div class="stat-card"><h2>Leaks</h2><span id="stat-leaks">0</span></div>
      </div>
      <div class="message" id="game-message">Build a leak-free path and reach the sink.</div>
      <div class="instructions">
        <p><strong>Drag</strong> a pipe from the palette onto the grid. Locked tiles mark the source and sink.</p>
        <p><strong>Rearrange</strong> by dragging a placed pipe back into position. Completing a leak-free route before time runs out awards bonus points.</p>
      </div>
      <div class="palette" id="pipe-palette"></div>
      <div class="actions">
        <button class="action" id="advance-level" disabled>Next Level</button>
        <button class="action" id="reset-level">Reset Level</button>
      </div>
    </aside>
  </div>
`;const N=document.querySelector("#game-canvas"),O=document.querySelector("#pipe-palette"),W=document.querySelector("#game-message"),ie={level:document.querySelector("#stat-level"),score:document.querySelector("#stat-score"),time:document.querySelector("#stat-time"),leaks:document.querySelector("#stat-leaks")},$=document.querySelector("#advance-level"),U=document.querySelector("#reset-level");if(!N||!O||!W||!$||!U)throw new Error("Failed to initialise UI elements.");oe({canvas:N,paletteContainer:O,messageElement:W,stats:ie,advanceButton:$,resetButton:U});
